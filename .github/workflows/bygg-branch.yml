name: Bygg branch

on:
    push:
        branches:
            - '*'
            - '!master'

jobs:
    bygg:
        name: Bygg branch
        runs-on: ubuntu-latest
        permissions:
            contents: 'read'
            id-token: 'write'
            packages: 'write'
        steps:
            - name: Sjekk ut kode
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - uses: actions/setup-node@v3
              with:
                  node-version: '20'
                  registry-url: https://npm.pkg.github.com/
                  cache: 'npm'

            - run: npm ci
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}

            - run: npm run lint

            - run: npm run build
              env:
                  PUBLIC_URL: https://cdn.nav.no/fager/min-side-arbeidsgiver/build/

            - uses: nais/docker-build-push@v0
              id: gar-push
              with:
                  team: fager
                  tag: ${{ github.sha }}
                  project_id: ${{ vars.NAIS_MANAGEMENT_PROJECT_ID }}
                  identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}

            - id: upload
              uses: navikt/frontend/actions/cdn-upload/v1@main
              with:
                  cdn-team-name: fager
                  source: ./build/
                  destination: '/min-side-arbeidsgiver'
