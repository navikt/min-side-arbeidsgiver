name: CICD

on:
    push:
    workflow_dispatch:

jobs:
    cicd:
        name: CICD
        runs-on: ubuntu-latest
        permissions:
            contents: 'read'
            id-token: 'write'
            packages: 'write'
        steps:
            - uses: actions/checkout@v3

            - uses: actions/setup-node@v3
              with:
                  node-version: '20'
                  registry-url: https://npm.pkg.github.com/
                  cache: 'npm'

            - name: Installer avhengigheter for test
              run: npm ci
              env:
                NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}
            - run: npm run test
            - run: npm run lint

            - name: Installer avhengigheter (server)
              run: npm ci --omit=dev --omit=optional
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}
              working-directory: ./server

            - name: Installer avhengigheter (client)
              run: npm ci --omit=dev --omit=optional
              env:
                NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}
            - run: npm run build
              env:
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_LOG_LEVEL: info

            - uses: nais/docker-build-push@v0
              id: dockerpush
              with:
                  team: fager
                  tag: ${{ github.sha }}
                  project_id: ${{ vars.NAIS_MANAGEMENT_PROJECT_ID }}
                  identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}

            - id: upload
              uses: navikt/frontend/actions/cdn-upload/v1@main
              with:
                  cdn-team-name: fager
                  source: ./build/
                  destination: '/min-side-arbeidsgiver'

            - name: Deploy til dev-gcp
              uses: nais/deploy/actions/deploy@v1
              if: github.ref == 'refs/heads/master'
              env:
                  APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                  IMAGE: ${{ steps.dockerpush.outputs.image }}
                  CLUSTER: dev-gcp
                  RESOURCE: nais/dev-gcp.yaml
                  PRINT_PAYLOAD: true
                  VAR: commit=${{ github.sha }}

            - name: Deploy til prod-gcp
              uses: nais/deploy/actions/deploy@v1
              if: github.ref == 'refs/heads/master'
              env:
                  APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                  IMAGE: ${{ steps.dockerpush.outputs.image }}
                  CLUSTER: prod-gcp
                  RESOURCE: nais/prod-gcp.yaml
                  PRINT_PAYLOAD: true
                  VAR: commit=${{ github.sha }}

            - name: Deploy prodlik demo til dev-gcp
              uses: nais/deploy/actions/deploy@v1
              if: github.ref == 'refs/heads/master'
              env:
                  APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                  IMAGE: ${{ steps.dockerpush.outputs.image }}
                  CLUSTER: dev-gcp
                  RESOURCE: nais/demo-prodlik.yaml
                  PRINT_PAYLOAD: true
                  VAR: commit=${{ github.sha }}

            - name: Deploy dev-lik demo til dev-gcp
              if: github.ref == 'refs/heads/master'
              uses: nais/deploy/actions/deploy@v1
              env:
                  APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                  IMAGE: ${{ steps.dockerpush.outputs.image }}
                  CLUSTER: dev-gcp
                  RESOURCE: nais/demo-devlik.yaml
                  PRINT_PAYLOAD: true
                  VAR: commit=${{ github.sha }}
